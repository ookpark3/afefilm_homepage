<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Page</title>
    <style>
      body {
        margin: 0;
      }
      /* 스크롤 방지를 위한 클래스 */
      body.no-scroll {
        overflow: hidden;
      }
      /* 로딩 페이지 스타일 */
      .loading-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 0.5s;
        background-color: #000;
      }
      /* 비디오 컨테이너 스타일 */
      .video-container-reel {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
      }
      /* 메인 비디오 스타일 */
      .main-2-1 {
        width: 100%;
        height: 100%;
      }
      #timer {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: #fff;
        font-size: 20px;
        z-index: 9999; /* 최대한 보이도록 z-index 설정 */
      }
    </style>
  </head>
  <body>
    <!-- 로딩 페이지 -->
    <div id="loading-page" class="loading-page">
      <picture>
        <!-- WebP 이미지 소스 -->
        <source
          srcset="https://d1iub2snqs2x58.cloudfront.net/afe-loading.webp"
          type="image/webp"
        />
        <!-- 대체 GIF 이미지 -->
        <img
          src="https://d1iub2snqs2x58.cloudfront.net/afe-loading.gif"
          alt="Content is loading, please wait."
          loading="lazy"
          decoding="async"
        />
      </picture>
    </div>
    <!-- 비디오 컨테이너 -->
    <div class="video-container-reel"></div>
    <div id="timer">0초 경과</div>

    <script>
      let secondsElapsed = 0;
      let mainVideo;

      document.addEventListener('DOMContentLoaded', async function () {
        document.body.classList.add('no-scroll');

        const loadingPage = document.getElementById('loading-page');
        const loadingImage = loadingPage.querySelector('img');
        mainVideo = document.createElement('video');
        const videoContainer = document.querySelector('.video-container-reel');

        mainVideo.classList.add('main-2-1');
        mainVideo.muted = true;
        mainVideo.playsInline = true;
        mainVideo.loop = true;
        videoContainer.appendChild(mainVideo);

        function isMobile() {
          return window.innerWidth <= 1024;
        }

        function setVideoSource() {
          const videoSource = isMobile()
            ? 'https://afefilm.com/asset/main/afe-reel-mobile.mp4'
            : 'https://afefilm.com/asset/main/afe-reel-web.mp4';
          if (mainVideo.src !== videoSource) {
            mainVideo.src = videoSource;
            mainVideo.load();
          }
        }

        setVideoSource();
        window.addEventListener('resize', setVideoSource);

        function preloadImage(img) {
          return new Promise((resolve, reject) => {
            if (img.complete) {
              resolve();
            } else {
              img.onload = resolve;
              img.onerror = reject;
            }
          });
        }

        function closeLoadingPage() {
          return new Promise((resolve) => {
            loadingPage.style.opacity = '0';
            mainVideo.play().catch(() => {});
            setTimeout(() => {
              loadingPage.style.display = 'none';
              document.body.classList.remove('no-scroll');
              resolve();
            }, 500);
          });
        }

        try {
          await preloadImage(loadingImage);
          await new Promise((resolve) => setTimeout(resolve, 3900));

          const mainVideoReadyPromise = new Promise((resolve) => {
            const checkReadyState = () => {
              if (mainVideo.readyState >= 2) {
                resolve();
              } else {
                requestAnimationFrame(checkReadyState);
              }
            };
            checkReadyState();
          });

          let timeoutId;
          const timeoutPromise = new Promise((resolve) => {
            timeoutId = setTimeout(() => {
              console.log('10초 타임아웃 발생'); // 디버깅용 로그 추가
              resolve();
            }, 10000);
          });

          const networkStatusPromise = new Promise((resolve) => {
            if (navigator.onLine) {
              resolve();
            } else {
              window.addEventListener('online', resolve, { once: true });
            }
          });

          await Promise.race([
            Promise.all([mainVideoReadyPromise, networkStatusPromise]).then(
              () => {
                clearTimeout(timeoutId); // 타임아웃 취소
              },
            ),
            timeoutPromise,
          ]);

          await closeLoadingPage();
          mainVideo.play().catch(() => {});
        } catch (error) {
          await closeLoadingPage();
        }
      });

      document.body.addEventListener(
        'touchstart',
        () => {
          if (mainVideo && mainVideo.paused) {
            mainVideo.play().catch(() => {});
          }
        },
        { passive: true },
      );

      const updateTimer = () => {
        const timerElement = document.getElementById('timer');
        timerElement.textContent = `${secondsElapsed}초 경과`;
      };

      const timerInterval = setInterval(() => {
        secondsElapsed++;
        updateTimer();
      }, 1000);
    </script>
  </body>
</html>
